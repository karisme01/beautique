!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@antv/g-lite")):"function"==typeof define&&define.amd?define(["exports","@antv/g-lite"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).G=e.G||{},e.G.CanvasRenderer={}),e.window.G)}(this,(function(e,t){"use strict";var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+t+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var i=function(){return i=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i.apply(this,arguments)};function o(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}var a=function(e){return null==e},l={}.toString,s=function(e,t){return l.call(e)==="[object "+t+"]"},h="undefined"!=typeof Float32Array?Float32Array:Array;function c(){var e=new h(16);return h!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function d(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function u(e,t,r){var n=t[0],i=t[1],o=t[2],a=t[3],l=t[4],s=t[5],h=t[6],c=t[7],d=t[8],u=t[9],p=t[10],f=t[11],y=t[12],v=t[13],g=t[14],m=t[15],A=r[0],x=r[1],b=r[2],S=r[3];return e[0]=A*n+x*l+b*d+S*y,e[1]=A*i+x*s+b*u+S*v,e[2]=A*o+x*h+b*p+S*g,e[3]=A*a+x*c+b*f+S*m,e[4]=(A=r[4])*n+(x=r[5])*l+(b=r[6])*d+(S=r[7])*y,e[5]=A*i+x*s+b*u+S*v,e[6]=A*o+x*h+b*p+S*g,e[7]=A*a+x*c+b*f+S*m,e[8]=(A=r[8])*n+(x=r[9])*l+(b=r[10])*d+(S=r[11])*y,e[9]=A*i+x*s+b*u+S*v,e[10]=A*o+x*h+b*p+S*g,e[11]=A*a+x*c+b*f+S*m,e[12]=(A=r[12])*n+(x=r[13])*l+(b=r[14])*d+(S=r[15])*y,e[13]=A*i+x*s+b*u+S*v,e[14]=A*o+x*h+b*p+S*g,e[15]=A*a+x*c+b*f+S*m,e}function p(){var e=new h(3);return h!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function f(e,t,r){var n=t[0],i=t[1],o=t[2],a=r[3]*n+r[7]*i+r[11]*o+r[15];return e[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])/(a=a||1),e[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])/a,e[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])/a,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),p();var y=function(){function e(e){this.canvasRendererPluginOptions=e,this.removedRBushNodeAABBs=[],this.renderQueue=[],this.restoreStack=[],this.clearFullScreenLastFrame=!1,this.clearFullScreen=!1,this.vpMatrix=c(),this.dprMatrix=c(),this.tmpMat4=c(),this.vec3a=p(),this.vec3b=p(),this.vec3c=p(),this.vec3d=p()}return e.prototype.apply=function(r,n){var i=this;this.context=r;var a=r.config,l=r.camera,s=r.renderingService,h=r.renderingContext,c=r.pathGeneratorFactory;this.rBush=r.rBushRoot,this.pathGeneratorFactory=c;var d=r.contextService,p=h.root.ownerDocument.defaultView,y=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)},v=function(e){var t=e.target.rBushNode;t.aabb&&i.removedRBushNodeAABBs.push(t.aabb)};s.hooks.init.tap(e.tag,(function(){p.addEventListener(t.ElementEvent.UNMOUNTED,y),p.addEventListener(t.ElementEvent.CULLED,v);var e=d.getDPR(),r=a.width,n=a.height,o=d.getContext();i.clearRect(o,0,0,r*e,n*e,a.background)})),s.hooks.destroy.tap(e.tag,(function(){p.removeEventListener(t.ElementEvent.UNMOUNTED,y),p.removeEventListener(t.ElementEvent.CULLED,v),i.renderQueue=[],i.removedRBushNodeAABBs=[],i.restoreStack=[]})),s.hooks.beginFrame.tap(e.tag,(function(){var e,t=d.getContext(),r=d.getDPR(),n=a.width,o=a.height,l=i.canvasRendererPluginOptions,h=l.dirtyObjectNumThreshold,c=l.dirtyObjectRatioThreshold,u=s.getStats(),f=u.rendered,y=f/u.total;i.clearFullScreen=i.clearFullScreenLastFrame||!(null===(e=p.context.renderingPlugins[1])||void 0===e?void 0:e.isFirstTimeRenderingFinished)||s.disableDirtyRectangleRendering()||f>h&&y>c,t&&(t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),i.clearFullScreen&&i.clearRect(t,0,0,n*r,o*r,a.background))}));var g=function(e,t){e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,t,i.context,i.restoreStack,n),(e.sortable.sorted||e.childNodes).forEach((function(e){g(e,t)}))};s.hooks.endFrame.tap(e.tag,(function(){if(0!==h.root.childNodes.length){i.clearFullScreenLastFrame=!1;var e,r,s=d.getContext(),c=d.getDPR();if((e=i.dprMatrix)[0]=(r=[c,c,1])[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=r[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,u(i.vpMatrix,i.dprMatrix,l.getOrthoMatrix()),i.clearFullScreen)g(h.root,s);else{var y=i.safeMergeAABB.apply(i,function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;o>i;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}([i.mergeDirtyAABBs(i.renderQueue)],o(i.removedRBushNodeAABBs.map((function(e){var r=e.minX,n=e.minY,i=e.maxX,o=e.maxY,a=new t.AABB;return a.setMinMax([r,n,0],[i,o,0]),a}))),!1));if(i.removedRBushNodeAABBs=[],t.AABB.isEmpty(y))return void(i.renderQueue=[]);var v=i.convertAABB2Rect(y),m=v.x,A=v.y,x=v.width,b=v.height,S=f(i.vec3a,[m,A,0],i.vpMatrix),B=f(i.vec3b,[m+x,A,0],i.vpMatrix),M=f(i.vec3c,[m,A+b,0],i.vpMatrix),R=f(i.vec3d,[m+x,A+b,0],i.vpMatrix),w=Math.min(S[0],B[0],R[0],M[0]),O=Math.min(S[1],B[1],R[1],M[1]),E=Math.max(S[0],B[0],R[0],M[0]),C=Math.max(S[1],B[1],R[1],M[1]),T=Math.floor(w),P=Math.floor(O),N=Math.ceil(E-w),L=Math.ceil(C-O);s.save(),i.clearRect(s,T,P,N,L,a.background),s.beginPath(),s.rect(T,P,N,L),s.clip(),s.setTransform(i.vpMatrix[0],i.vpMatrix[1],i.vpMatrix[4],i.vpMatrix[5],i.vpMatrix[12],i.vpMatrix[13]),a.renderer.getConfig().enableDirtyRectangleRenderingDebug&&p.dispatchEvent(new t.CustomEvent(t.CanvasEvent.DIRTY_RECTANGLE,{dirtyRect:{x:T,y:P,width:N,height:L}})),i.searchDirtyObjects(y).sort((function(e,t){return e.sortable.renderOrder-t.sortable.renderOrder})).forEach((function(e){e&&e.isVisible()&&!e.isCulled()&&i.renderDisplayObject(e,s,i.context,i.restoreStack,n)})),s.restore(),i.renderQueue.forEach((function(e){i.saveDirtyAABB(e)})),i.renderQueue=[]}i.restoreStack.forEach((function(){s.restore()})),i.restoreStack=[]}else i.clearFullScreenLastFrame=!0})),s.hooks.render.tap(e.tag,(function(e){i.clearFullScreen||i.renderQueue.push(e)}))},e.prototype.clearRect=function(e,t,r,n,i,o){e.clearRect(t,r,n,i),o&&(e.fillStyle=o,e.fillRect(t,r,n,i))},e.prototype.renderDisplayObject=function(e,r,n,i,o){var a=e.nodeName,l=i[i.length-1];!l||e.compareDocumentPosition(l)&t.Node.DOCUMENT_POSITION_CONTAINS||(r.restore(),i.pop());var s=this.context.styleRendererFactory[a],h=this.pathGeneratorFactory[a],c=e.parsedStyle.clipPath;if(c){this.applyWorldTransform(r,c);var d=this.pathGeneratorFactory[c.nodeName];d&&(r.save(),i.push(e),r.beginPath(),d(r,c.parsedStyle),r.closePath(),r.clip())}s&&(this.applyWorldTransform(r,e),r.save(),this.applyAttributesToContext(r,e)),h&&(r.beginPath(),h(r,e.parsedStyle),e.nodeName!==t.Shape.LINE&&e.nodeName!==t.Shape.PATH&&e.nodeName!==t.Shape.POLYLINE&&r.closePath()),s&&(s.render(r,e.parsedStyle,e,n,this,o),r.restore()),e.renderable.dirty=!1},e.prototype.convertAABB2Rect=function(e){var t=e.getMin(),r=e.getMax(),n=Math.floor(t[0]),i=Math.floor(t[1]);return{x:n,y:i,width:Math.ceil(r[0])-n,height:Math.ceil(r[1])-i}},e.prototype.mergeDirtyAABBs=function(e){var r=new t.AABB;return e.forEach((function(e){var t=e.getRenderBounds();r.add(t);var n=e.renderable.dirtyRenderBounds;n&&r.add(n)})),r},e.prototype.searchDirtyObjects=function(e){var t=o(e.getMin(),2),r=t[0],n=t[1],i=o(e.getMax(),2);return this.rBush.search({minX:r,minY:n,maxX:i[0],maxY:i[1]}).map((function(e){return e.displayObject}))},e.prototype.saveDirtyAABB=function(e){var r=e.renderable;r.dirtyRenderBounds||(r.dirtyRenderBounds=new t.AABB);var n=e.getRenderBounds();n&&r.dirtyRenderBounds.update(n.center,n.halfExtents)},e.prototype.applyAttributesToContext=function(e,t){var r=t.parsedStyle,n=r.stroke,i=r.fill,o=r.opacity,l=r.lineDash,s=r.lineDashOffset;l&&e.setLineDash(l),a(s)||(e.lineDashOffset=s),a(o)||(e.globalAlpha*=o),a(n)||Array.isArray(n)||n.isNone||(e.strokeStyle=t.attributes.stroke),a(i)||Array.isArray(i)||i.isNone||(e.fillStyle=t.attributes.fill)},e.prototype.applyWorldTransform=function(e,t,r){r?(d(this.tmpMat4,t.getLocalTransform()),u(this.tmpMat4,r,this.tmpMat4),u(this.tmpMat4,this.vpMatrix,this.tmpMat4)):(d(this.tmpMat4,t.getWorldTransform()),u(this.tmpMat4,this.vpMatrix,this.tmpMat4)),e.setTransform(this.tmpMat4[0],this.tmpMat4[1],this.tmpMat4[4],this.tmpMat4[5],this.tmpMat4[12],this.tmpMat4[13])},e.prototype.safeMergeAABB=function(){for(var e=[],r=0;arguments.length>r;r++)e[r]=arguments[r];var n=new t.AABB;return e.forEach((function(e){n.add(e)})),n},e.tag="CanvasRenderer",e}(),v=function(){function e(e){this.imagePool=e}return e.prototype.render=function(e,r,n,i,o,l){var s=r.fill,h=r.fillRule,c=r.opacity,d=void 0===c?1:c,u=r.fillOpacity,p=void 0===u?1:u,f=r.stroke,y=r.strokeOpacity,v=void 0===y?1:y,m=r.lineWidth,A=void 0===m?1:m,x=r.lineCap,b=r.lineJoin,S=r.shadowType,B=r.shadowColor,M=r.shadowBlur,R=r.filter,w=r.miterLimit,O=!a(s)&&!s.isNone,E=!a(f)&&!f.isNone&&A>0,C=0===(null==s?void 0:s.alpha),T=!(!R||!R.length),P=!a(B)&&M>0,N=n.nodeName,L="inner"===S,F=E&&P&&(N===t.Shape.PATH||N===t.Shape.LINE||N===t.Shape.POLYLINE||C||L);O&&(e.globalAlpha=d*p,F||g(n,e,P),this.fill(e,n,s,h,i,o,l),F||this.clearShadowAndFilter(e,T,P)),E&&(e.globalAlpha=d*v,e.lineWidth=A,a(w)||(e.miterLimit=w),a(x)||(e.lineCap=x),a(b)||(e.lineJoin=b),F&&(L&&(e.globalCompositeOperation="source-atop"),g(n,e,!0),L&&(this.stroke(e,n,f,i,o,l),e.globalCompositeOperation="source-over",this.clearShadowAndFilter(e,T,!0))),this.stroke(e,n,f,i,o,l))},e.prototype.clearShadowAndFilter=function(e,t,r){if(r&&(e.shadowColor="transparent",e.shadowBlur=0),t){var n=e.filter;!a(n)&&n.indexOf("drop-shadow")>-1&&(e.filter=n.replace(/drop-shadow\([^)]*\)/,"").trim()||"none")}},e.prototype.fill=function(e,r,n,i,o,a,l){var s=this;Array.isArray(n)?n.forEach((function(t){e.fillStyle=s.getColor(t,r,e),i?e.fill(i):e.fill()})):(t.isPattern(n)&&(e.fillStyle=this.getPattern(n,r,e,o,a,l)),i?e.fill(i):e.fill())},e.prototype.stroke=function(e,r,n,i,o,a){var l=this;Array.isArray(n)?n.forEach((function(t){e.strokeStyle=l.getColor(t,r,e),e.stroke()})):(t.isPattern(n)&&(e.strokeStyle=this.getPattern(n,r,e,i,o,a)),e.stroke())},e.prototype.getPattern=function(e,t,r,n,i,o){var a,l;if("rect"===e.image.nodeName){var s=e.image.parsedStyle,h=s.width,c=s.height;l=n.contextService.getDPR();var d=n.config.offscreenCanvas;(a=o.offscreenCanvasCreator.getOrCreateCanvas(d)).width=h*l,a.height=c*l;var u=o.offscreenCanvasCreator.getOrCreateContext(d),p=[];e.image.forEach((function(e){i.renderDisplayObject(e,u,n,p,o)})),p.forEach((function(){u.restore()}))}return this.imagePool.getOrCreatePatternSync(e,r,a,l,t.getGeometryBounds().min,(function(){t.renderable.dirty=!0,n.renderingService.dirtify()}))},e.prototype.getColor=function(e,r,n){var o;if(e.type===t.GradientType.LinearGradient||e.type===t.GradientType.RadialGradient){var a=r.getGeometryBounds(),l=a&&2*a.halfExtents[0]||1,s=a&&2*a.halfExtents[1]||1,h=a&&a.min||[0,0];o=this.imagePool.getOrCreateGradient(i(i({type:e.type},e.value),{min:h,width:l,height:s}),n)}return o},e}();function g(e,t,r){var n=e.parsedStyle,i=n.filter,o=n.shadowColor,a=n.shadowBlur,l=n.shadowOffsetX,s=n.shadowOffsetY;i&&i.length&&(t.filter=e.style.filter),r&&(t.shadowColor=""+o,t.shadowBlur=a||0,t.shadowOffsetX=l||0,t.shadowOffsetY=s||0)}var m=function(){function e(e){this.imagePool=e}return e.prototype.render=function(e,t,r){var n,i=t.x,o=void 0===i?0:i,l=t.y,h=void 0===l?0:l,c=t.src,d=t.shadowColor,u=t.shadowBlur,p=t.width,f=t.height;if(s(c,"String")?n=this.imagePool.getImageSync(c):(p||(p=c.width),f||(f=c.height),n=c),n){g(r,e,!a(d)&&u>0);try{e.drawImage(n,o,h,p,f)}catch(e){}}},e}(),A=function(){function e(){}return e.prototype.render=function(e,t,r,n,i,o){r.getBounds();var l=t.lineWidth,s=void 0===l?1:l,h=t.textAlign,c=void 0===h?"start":h,d=t.textBaseline,u=void 0===d?"alphabetic":d,p=t.lineJoin,f=void 0===p?"miter":p,y=t.miterLimit,v=void 0===y?10:y,m=t.letterSpacing,A=void 0===m?0:m,x=t.stroke,b=t.fill,S=t.fillOpacity,B=void 0===S?1:S,M=t.strokeOpacity,R=void 0===M?1:M,w=t.opacity,O=void 0===w?1:w,E=t.metrics,C=t.x,T=void 0===C?0:C,P=t.y,N=void 0===P?0:P,L=t.dx,F=t.dy,k=t.shadowColor,D=t.shadowBlur,G=E.lines,j=E.height,I=E.lineHeight,Y=E.lineMetrics;e.font=E.font,e.lineWidth=s,e.textAlign="middle"===c?"center":c;var _=u;o.enableCSSParsing||"alphabetic"!==_||(_="bottom"),e.lineJoin=f,a(v)||(e.miterLimit=v);var U=N;"middle"===u?U+=-j/2-I/2:"bottom"===u||"alphabetic"===u||"ideographic"===u?U+=-j:"top"!==u&&"hanging"!==u||(U+=-I);var W=T+(L||0);U+=F||0,1===G.length&&("bottom"===_?(_="middle",U-=.5*j):"top"===_&&(_="middle",U+=.5*j)),e.textBaseline=_,g(r,e,!a(k)&&D>0);for(var Q=0;G.length>Q;Q++){var X=s/2+W;U+=I,a(x)||x.isNone||!s||this.drawLetterSpacing(e,G[Q],Y[Q],c,X,U,A,B,R,O,!0),a(b)||this.drawLetterSpacing(e,G[Q],Y[Q],c,X,U,A,B,R,O)}},e.prototype.drawLetterSpacing=function(e,t,r,n,i,o,a,l,s,h,c){if(void 0===c&&(c=!1),0!==a){var d=e.textAlign;e.textAlign="left";var u=i;"center"===n||"middle"===n?u=i-r.width/2:"right"!==n&&"end"!==n||(u=i-r.width);for(var p=Array.from(t),f=e.measureText(t).width,y=0,v=0;p.length>v;++v){var g=p[v];c?this.strokeText(e,g,u,o,s):this.fillText(e,g,u,o,l,h),u+=f-(y=e.measureText(t.substring(v+1)).width)+a,f=y}e.textAlign=d}else c?this.strokeText(e,t,i,o,s):this.fillText(e,t,i,o,l,h)},e.prototype.fillText=function(e,t,r,n,i,o){var l,s=!a(i)&&1!==i;s&&(l=e.globalAlpha,e.globalAlpha=i*o),e.fillText(t,r,n),s&&(e.globalAlpha=l)},e.prototype.strokeText=function(e,t,r,n,i){var o,l=!a(i)&&1!==i;l&&(o=e.globalAlpha,e.globalAlpha=i),e.strokeText(t,r,n),l&&(e.globalAlpha=o)},e}(),x=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),S=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),B=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),M=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),R=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),w=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(v),O=function(e){function r(t){void 0===t&&(t={});var r=e.call(this)||this;return r.options=t,r.name="canvas-renderer",r}return n(r,e),r.prototype.init=function(){var e,r=i({dirtyObjectNumThreshold:500,dirtyObjectRatioThreshold:.8},this.options),n=this.context.imagePool,o=new v(n),a=((e={})[t.Shape.CIRCLE]=o,e[t.Shape.ELLIPSE]=o,e[t.Shape.RECT]=o,e[t.Shape.IMAGE]=new m(n),e[t.Shape.TEXT]=new A,e[t.Shape.LINE]=o,e[t.Shape.POLYLINE]=o,e[t.Shape.POLYGON]=o,e[t.Shape.PATH]=o,e[t.Shape.GROUP]=void 0,e[t.Shape.HTML]=void 0,e[t.Shape.MESH]=void 0,e);this.context.defaultStyleRendererFactory=a,this.context.styleRendererFactory=a,this.addRenderingPlugin(new y(r))},r.prototype.destroy=function(){this.removeAllRenderingPlugins(),delete this.context.defaultStyleRendererFactory,delete this.context.styleRendererFactory},r}(t.AbstractRendererPlugin);e.CircleRenderer=b,e.EllipseRenderer=S,e.ImageRenderer=m,e.LineRenderer=B,e.PathRenderer=w,e.Plugin=O,e.PolygonRenderer=R,e.PolylineRenderer=M,e.RectRenderer=x,e.TextRenderer=A}));
//# sourceMappingURL=index.umd.min.js.map
